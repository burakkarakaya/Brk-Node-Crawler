<!DOCTYPE html>

<html lang="en">

<head>
    <title>Crawler</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="/js/jquery-base.min.js"></script>
    <script type="text/javascript" src="/js/config.js"></script>
</head>

<body>
   
    <select>
        <option value="-1">Marka Seçiniz</option>
        <option value="vw">Volkswagen</option>
        <option value="renault">Renault</option>
        <option value="ford">Ford</option>
        <option value="fiat">Fiat</option>
        <option value="opel">Opel</option>
        <option value="toyota">Toyota</option>
        <option value="bmw">Bmw</option>
        <option value="mercedes">Mercedes</option>
    </select>

    <noscript>

    </noscript>
   
   
   <script>
        var bdy = $('body'),
            uty = {
                trimText: function (k) {
                    return k.replace(/(^\s+|\s+$)/g, '');
                },
                cleanText: function (k) {
                    return k.replace(/\s+/g, '');
                },
                cleanAttr: function( k ){
                    return k.replace(/<([a-z][a-z0-9]*)[^>]*?(\/?)>/ig, '<$1>');
                },
                detectEl: function (ID) {
                    return ID.length > 0 ? true : false;
                },
                setURI: function( o ){
                    o = o || {};
                    var _t = this, prefix = o['prefix'], uri = o['uri'] || '';
                    if( uri != '' && uri.indexOf( prefix ) == -1 && uri.indexOf('http://') == -1 && uri.indexOf('https://') == -1 ){
                        if( uri.substr( 0, 1 ) == '/')
                            uri = uri.substr(1, uri.length);
                        uri = prefix + uri;
                    }
                    return uri;
                },
                detectObj: function( o ){
                    var b = false;
                    $.each(o, function( i, k ){
                        if( k != '' )
                            b = true;
                    });

                    return b;
                },
                ajx: function (o, callback) {
                    o = o || {};
                    $.ajax({
                        type: o['type'] || 'GET',
                        dataType: o['dataType'] || 'html',
                        url: o['uri'] || '',
                        data: o['param'] || {},
                        contentType: o['contentType'] || '',
                        error: function (e) {
                            if (typeof callback !== 'undefined')
                                callback({ type: 'error' });
                        },
                        timeout: 30000,
                        success: function (d) {
                            if (typeof callback !== 'undefined')
                                callback({ type: 'success', val: d });
                        }
                    });
                },
                clearScriptTag: function( k ){
                    var SCRIPT_REGEX = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;
                    while( SCRIPT_REGEX.test( k ) )
                        k = k.replace(SCRIPT_REGEX, '');	
                    return k;
                }
            },
            crawler = {
                el: { select: 'select' },
                uri: '/api/?uri={{uri}}',
                getURI: function (o) {
                    o = o || {};
                    var _t = this;
                    return _t['uri'].replace(/{{uri}}/g, o['uri'] || '');
                },
                getConfig: function (o) {
                    console.clear();
                    o = o || {};
                    var _t = this, typ = o['typ'] || '', obj = CONFIG[typ] || {};
                    uty.ajx({ uri: _t.getURI({ uri: obj['prefix'] + obj['uri'] }) }, function (d) {
                        if (d['type'] == 'success') {
                            $('noscript').html( uty.clearScriptTag( d['val'] || '' ) );
                            d = $('noscript').html() || '';
                            
                            var func = obj['func'] || ''; 
                            if( func != '' )
                                d = func( d );
    
                            var arr = [];

                            $('<div>' + d + '</div>')
                            .find( obj['el']['items'] )
                            .each(function(){
                                var ths = $( this ), img = obj['el']['img'];
                                
                                if( typeof img == 'object' ){
                                    var cf = img['customFunc'] || '';
                                    img = ths.find( img['el'] ).attr( img['attr'] ) || ''; 
                                    if( cf != '' )
                                        img = cf( img );    
                                }else
                                    img = ths.find( obj['el']['img'] ).attr('src') || '';

                                  
                                var b = { 
                                    title: uty.trimText( ths.find( obj['el']['title'] ).text() || '' ), 
                                    dsc: uty.trimText( ths.find( obj['el']['dsc'] ).text() || '' ), 
                                    date: uty.trimText( ths.find( obj['el']['date'] ).text() || '' ), 
                                    img: uty.trimText( uty.setURI({ uri: img, prefix: obj['prefix'] }) ), 
                                    lnk: uty.trimText( uty.setURI({ uri: obj['el']['lnk'] == 'self' ? ( ths.attr('href') || '' ) : ( ths.find( obj['el']['lnk'] ).attr('href') || '' ), prefix: obj['prefix'] }) )
                                }; 

                                if( uty.detectObj( b ) )
                                    arr.push( b );
                            });

                            console.log( arr );
                        }
                    });
                },
                addEvent: function(){
                    var _t = this;
                    $( _t.el.select )
                    .bind('change', function(){
                        var ths = $( this ), val = ths.val() || -1;
                        if( val != -1 && CONFIG[ val ] )
                            _t.getConfig({ typ: val });
                        else{
                            console.clear()
                            console.log('Lütfen seçim yapınız');     
                        }    
                            
                    });
                },
                init: function () {
                    var _t = this;
                        _t.addEvent();
                }
            };

            crawler.init();

    </script>
</body>

</html>